<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>ZK Yellowpages</title>
</head>

<body>
    <h1>A Privacy-Preserving Directory. Discover your network, privately.</h1>

    <!-- Form to register an interest -->
    <h2>Register Your Interest</h2>
    <form id="registerForm">
        <label> Name (or Alias):
            <input type="text" id="name" required />
        </label><br />
        <label> Interest:
            <input type="text" id="interest" required />
        </label><br />
        <br>
        <button type="submit">Submit</button>
    </form>

    <br><br>

    <!-- Search Box -->
    <input type="text" id="searchBox" placeholder="Enter interest here..." />
    <button id="searchBtn">Search</button>

    <!-- Display results -->
    <div id="results"></div>

    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0';

        let extractor;

        async function loadEmbeddingModel() {
            extractor = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', { dtype: 'q8' });
            console.log('Sentence-BERT model loaded.'); // testing
        }

        document.addEventListener('DOMContentLoaded', loadEmbeddingModel);

        document.getElementById('searchBtn').onclick = async function () {
            const query = document.getElementById('searchBox').value.trim();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = "Generating embedding...";

            const embeddings = await extractor(query);
            const embeddingVector = embeddings[0];

            console.log(embeddingVector);  // testing
            resultsDiv.innerHTML = `<p>Embedding generated successfully (see console).</p>`;

            fetch(`http://localhost:5000/search?q=${encodeURIComponent(query)}`)
                .then(resp => resp.json())
                .then(data => {
                    resultsDiv.innerHTML = '';

                    if (data.error) {
                        resultsDiv.innerHTML = `<p>Error: ${data.error}</p>`;
                        return;
                    }

                    if (data.results.length === 0) {
                        resultsDiv.innerHTML = "<p>No matches found.</p>";
                        return;
                    }

                    data.results.forEach(entry => {
                        resultsDiv.innerHTML += `<p><strong>${entry.name}</strong>: ${entry.interests} <em>(Similarity: ${entry.score})</em></p>`;
                    });
                })
                .catch(err => {
                    console.error(err);
                    resultsDiv.innerHTML = '<p>Error fetching results from server.</p>';
                });
        };
    </script>


</body>

</html>