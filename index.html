<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>ZK Yellowpages with Encryption</title>
</head>

<body>
    <h1>Privacy-Preserving Directory with FHE Encryption</h1>

    <!-- Form to search -->
    <input type="text" id="searchBox" placeholder="Enter interest here..." />
    <button id="searchBtn">Search</button>
    <div id="results"></div>

    <script src="wasm_exec.js"></script>
    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0';

        let extractor, go, wasmInstance;

        // Load Sentence-BERT embedding model
        async function loadEmbeddingModel() {
            extractor = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', { dtype: 'q8' });
            console.log('Sentence-BERT model loaded.');
        }

        // Load Go WASM Module
        async function loadWasmModule() {
            go = new Go();
            const wasmResponse = await fetch('main.wasm');
            const wasmBytes = await wasmResponse.arrayBuffer();
            const { instance } = await WebAssembly.instantiate(wasmBytes, go.importObject);
            wasmInstance = instance;
            go.run(wasmInstance);
            console.log('Go WASM module loaded.');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadEmbeddingModel();
            await loadWasmModule();
        });

        document.getElementById('searchBtn').onclick = async function () {
            const query = document.getElementById('searchBox').value.trim();
            const resultsDiv = document.getElementById('results');
            if (!query) {
                resultsDiv.textContent = 'Please enter a search query.';
                return;
            }

            resultsDiv.textContent = 'Generating embedding...';

            const embeddings = await extractor(query);
            const embeddingVector = Array.from(embeddings[0].data); // fixed conversion

            resultsDiv.textContent = 'Encrypting embedding...';

            const encryptedEmbedding = await encryptEmbeddingWithWASM(embeddingVector);

            resultsDiv.textContent = 'Storing encrypted embedding in Iroh...';

            // Send to backend Python server to store in Iroh
            fetch("http://localhost:5000/store_embedding", {
                method: "POST",
                headers: {
                    "Content-Type": "application/octet-stream"
                },
                body: encryptedEmbedding
            })
                .then(resp => resp.json())
                .then(data => {
                    if (data.error) {
                        resultsDiv.textContent = "Error storing embedding: " + data.error;
                    } else {
                        resultsDiv.textContent = "Successfully stored embedding. CID: " + data.cid;
                        console.log("CID stored:", data.cid);
                    }
                })
                .catch(err => {
                    console.error(err);
                    resultsDiv.textContent = "Error communicating with backend.";
                });
        };

        // Helper to call Go WASM encryption function
        async function encryptEmbeddingWithWASM(vector) {
            return new Promise((resolve, reject) => {
                // Convert JS array to JSON string
                const vectorJSON = JSON.stringify(vector);

                // Call Go WASM encryption function (window.encryptVector)
                const cipherArray = window.encryptVector(vectorJSON);

                if (cipherArray instanceof Uint8Array) {
                    resolve(cipherArray);
                } else {
                    reject('Encryption failed: ' + cipherArray);
                }
            });
        }
    </script>
</body>

</html>